---
title: "Copa de la Liga 2024 - Midfielder Scoring Calculator"
subtitle: "M9 Task - MSc Data Analytics in Football"
author: "Tommy Las"
date: "2024-04-28"
output: html_document
---
#Introduction

Using a scoring calculator algorithm, we rank the best performing midfielders in Copa de La Liga 2024 Argentina.
We import a CSV file with data from FBref, with only some modifications in columns names.
The goal for this task is to clean the data, select the KPIs that are suitable for a defending midfielder, and apply a scoring algorithm to each player.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries

```{r libraries, warning=FALSE, message=FALSE, results='hide'}
library(readr)
library(tidyverse)
```

# Read CSV file

``` {r csv}
filename <- 'FBRef_2024_CopaDeLaLiga_MidfieldersAnalysis.csv'
raw_data <- read_csv(filename)
```

# Filter by position

We want to filter our data by position, we want players whose main position is *MF*.

``` {r filtering}
raw_data <- raw_data %>% filter(Pos == "MF")
```

We check the unique positions in our dataset.

``` {r}
cat("The unique positions in our data:", unique(raw_data$Pos[1]))
```

# Data filtering

Our next goal is to reduce our sample data. We want to filter players by *% minutes played*, *max age*. We are also selecting the features (metrics) that are specific for a defensive midfielder, reducing the number of columns.
We create the _filter_data_ function

``` {r data cleanup function}

filter_data <- function(data, metrics, max_age, min_minutes_percentage ){
  squad_matches_played <- 14 #copa de la liga matches before playoffs
  data_filter <- data %>%
    #Calculate the percentage a player played on their team, and compare to minimum percentage passed as parameter
    filter(min_minutes_percentage <= ((as.numeric(Min) / (90*squad_matches_played)) *100), 
           Age <= max_age) %>%
    select(c("Player", "Squad", "Min", metrics))
  
  return (data_filter)
}

```

```{r}
selected_metrics <- c("Progressive Passes", "Key Passes", "Interceptions", "Tackles" ,"Tackles Won", "Passes into Final Third", "Long Passes Attempted", "Long Passes Success %", "Total Passes Attempted", "Total Passes Success %","Total Blocks"  )
#Get our filtered dataset
filtered_data <- filter_data(raw_data, selected_metrics, 32, 30)

```


# Data Processing

Numeric metrics in our dataframe are strings, we need to modify them as numeric

```{r}

filtered_data[, 3:ncol(filtered_data)] <- sapply(filtered_data[, 3:ncol(filtered_data)], as.numeric)

```

There are some metrics in our dataframe that are total values, we want to know these metrics within a 90 minute frame, since one player may play more minutes than another player. We divide the metric by the 90s column.

```{r}

metrics_modified <- c("Progressive Passes", "Key Passes", "Interceptions", "Tackles", "Tackles Won","Passes into Final Third", "Long Passes Attempted", "Total Passes Attempted", "Total Passes Success %")

filtered_data[, metrics_modified] <- filtered_data[, metrics_modified] / (filtered_data$Min / 90)

```

We have "Tackles" and "Tackles Won" metrics, I want to create a "Tackle Success %" column

``` {r}

filtered_data["Tackles Won %"] <- (filtered_data["Tackles Won"] / filtered_data["Tackles"])*100
```

There some values that contain NA. We cannot make calculations with NA values, so I set all NA to 0
``` {r}
# Replace NA values with 0 in the entire dataframe
filtered_data[is.na(filtered_data)] <- 0
```
# Scoring Calculator Algorithm

Now that we filtered and processed the data, we create the scoring algorithm. We need to first normalize our data so every metric is on the same range. We use the min max normalizer.

## Normalizing function
``` {r normalizer}

normalizer <- function(x, na.rm=TRUE){
  return((x-min(x))/(max(x)-min(x)))
}

```

## Normalize the metrics

``` {r apply normalization}

#Make a copy of the dataframe, so we can normalize the data and apply the scoring algorithm
norm_data <- data.frame(filtered_data)

for (i in 4:length(filtered_data)){
  norm_data[,i] <- normalizer(filtered_data[,i])
}

#summary(norm_data)
```
