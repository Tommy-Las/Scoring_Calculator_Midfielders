---
title: "Copa de la Liga 2024 - Midfielder Scoring Calculator"
subtitle: "M9 Task - MSc Data Analytics in Football"
author: "Tommy Las"
date: "2024-04-28"
output: html_document
---
#Introduction

Using a scoring calculator algorithm, we rank the best performing midfielders in Copa de La Liga 2024 Argentina.
We import a CSV file with data from FBref, with only some modifications in columns names.
The goal for this task is to clean the data, select the KPIs that are suitable for a defending midfielder, and apply a scoring algorithm to each player.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries

```{r libraries, warning=FALSE, message=FALSE, results='hide'}
library(readr)
library(tidyverse)

```

# Read CSV file

``` {r csv}
filename <- 'FBRef_2024_CopaDeLaLiga_MidfieldersAnalysis.csv'
raw_data <- read_csv(filename)
```

# Filter by position

We want to filter our data by position, we want players whose main position is *MF*.

``` {r filtering}
raw_data <- raw_data %>% filter(Pos == "MF")
```

We check the unique positions in our dataset.

``` {r}
cat("The unique positions in our data:", unique(raw_data$Pos[1]))
```

# Data filtering

Our next goal is to reduce our sample data. We want to filter players by *% minutes played*, *max age*. We are also selecting the features (metrics) that are specific for a defensive midfielder, reducing the number of columns.
We create the _filter_data_ function

``` {r data cleanup function}

# This function filters the data by given metrics, maximum age of players, and the minimum percentage of minutes player for its team  .
# 
# @param data data.frame: The dataset to be processed.
# @param metrics character: A vector containing the metrics to be calculated.
# @param max_age numeric: The maximum age threshold for filtering the data.
# @param min_minutes_percentage numeric: The minimum percentage of minutes required for a player to be included.
#
# @return data.frame: The processed dataset.

filter_data <- function(data, metrics, max_age, min_minutes_percentage ){ 
  squad_matches_played <- 14 #copa de la liga matches before playoffs
  data_filter <- data %>%
    #Calculate the percentage a player played on their team, and compare to minimum percentage passed as parameter
    filter(min_minutes_percentage <= ((as.numeric(Min) / (90*squad_matches_played)) *100), 
           Age <= max_age) %>%
    select(c("Player", "Squad", "Min", metrics))
  
  return (data_filter)
}

```

```{r}
selected_metrics <- c("Progressive Passes", "Key Passes", "Interceptions", "Tackles" ,"Tackles Won", "Passes into Final Third", "Long Passes Attempted", "Long Passes Success %", "Total Passes Attempted", "Total Passes Success %","Total Blocks"  )
#Get our filtered dataset
filtered_data <- filter_data(raw_data, selected_metrics, 32, 40)

```


# Data Processing

Numeric metrics in our dataframe are strings, we need to modify them as numeric

```{r}

filtered_data[, 3:ncol(filtered_data)] <- sapply(filtered_data[, 3:ncol(filtered_data)], as.numeric)

```

There are some metrics in our dataframe that are total values, we want to know these metrics within a 90 minute frame, since one player may play more minutes than another player. We divide the metric by the 90s column.

```{r}

metrics_modified <- c("Progressive Passes", "Key Passes", "Interceptions", "Tackles", "Tackles Won","Passes into Final Third", "Long Passes Attempted", "Total Passes Attempted", "Total Passes Success %")

filtered_data[, metrics_modified] <- filtered_data[, metrics_modified] / (filtered_data$Min / 90)

```

We have "Tackles" and "Tackles Won" metrics, I want to create a "Tackle Success %" column

``` {r}

filtered_data["Tackles Won %"] <- (filtered_data["Tackles Won"] / filtered_data["Tackles"])*100

#Drop tackles won since we have the % now
filtered_data <- subset(filtered_data, select = -`Tackles Won`)

```

There some values that contain NA. We cannot make calculations with NA values, so I set all NA to 0
``` {r}
# Replace NA values with 0 in the entire dataframe
filtered_data[is.na(filtered_data)] <- 0
```

# Normalization of the data

Before the scoring algorithm and comparison between players, we need to first normalize our data so every metric is on the same range. We use the min max normalizer.

## Normalizing function
``` {r normalizer}

# Normalizes a numeric vector between 0 and 1.
# 
# @param x numeric: A numeric vector to be normalized.
# @param na.rm logical: Indicates whether to remove NA values before normalization. Default is TRUE.
#
# @return numeric: The normalized vector.

normalizer <- function(x, na.rm=TRUE){
  return((x-min(x))/(max(x)-min(x)))
}

```

## Normalize the metrics

``` {r apply normalization}

#Make a copy of the dataframe, so we can normalize the data and apply the scoring algorithm
norm_data <- data.frame(filtered_data)

#We start from index 4, the first numeric column
for (i in 4:length(filtered_data)){
  norm_data[,i] <- normalizer(filtered_data[,i])
}

summary(norm_data)
```

# Scoring Calculator Algorithm

Now that we filtered, processed and normalized the data, we create the scoring algorithm. 

```{r}
# Calculates scores for players based on provided weights and data.
# 
# @param data data.frame: The dataset containing player metrics.
# @param weights numeric: A vector of weights corresponding to each metric being calculated.
# @param initial_index integer: The index of the first column where metrics start.
# @param columns_returned character: A vector of column names indicating which columns to include in the final dataframe.
# @param n_players integer: The total number of players we want to return, number of rows in the dataframe.
#
# @return numeric data.frame: Dataframe with best performing players based on the given metrics and weights. Sorted by Score descending.

scoring_calculator <- function(data, weights, initial_index, columns_returned, n_players){
  number_cols <- ncol(data)
  
  # Perform calcuation of each metric by multiplying by the given weight
  for(i in initial_index:number_cols){
    data[, i] <- data[,i] * weights[i-(initial_index-1)]
  }
  
  #Sum all the scores
  data$Score <- rowSums( data[, c(initial_index:number_cols) ] )
  
  #round score to 3 decimal places
  data$Score <- round(10*data$Score, 3)
  
  #Order dataframe by score
  data <- data[order(-data$Score), 
               c(columns_returned, "Score")]
  
  rownames(data) <- 1:nrow(data)
  
  return(data[1:n_players,])
}
```


``` {r}

colnames(norm_data) # metrics

df_score_midfielders <- scoring_calculator(
  data = norm_data, 
  weights = c(0.10, 0.05, 0.20, 0.20, 0.05, 0.015, 0.035, 
              0.10, 0.10, 0.05, 0.10), 
  initial_index = 4, 
  columns_returned = c("Player", "Squad"), 
  n_players = 10
)

df_score_midfielders

```